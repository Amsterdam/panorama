# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2016-07-12 09:07
from __future__ import unicode_literals

from django.db import migrations
from django.contrib.gis.db.models.fields import PointField

from geo_views import migrate


class Migration(migrations.Migration):

    dependencies = [
        ('panoramas', '0009_search_wider_area'),
    ]

    operations = [
        migrations.AddField(
            model_name='panorama',
            name='_geolocation_2d',
            field=PointField(default=None, null=True, srid=4326),
            preserve_default=False,
        ),
        migrations.RunSQL(
            "update public.panoramas_panorama set _geolocation_2d = geopoint",
            "update public.panoramas_panorama set geopoint = _geolocation_2d"
        ),
        migrations.RemoveField(
            model_name='panorama',
            name='geopoint'
        ),
        migrate.ManageMaterializedView(
            view_name="panoramas_adjacencies",
            sql="""
SELECT row_number() OVER (ORDER BY pp.id, pp1.id) AS id,
  pp.id AS from_pano_id,
  pp1.id AS to_pano_id,
  degrees(st_azimuth(geography(pp.geolocation), geography(pp1.geolocation))) AS heading,
  st_distance(geography(pp.geolocation), geography(pp1.geolocation)) AS distance,
  st_z(pp1.geolocation) - st_z(pp.geolocation) AS elevation
FROM panoramas_panorama pp,
    panoramas_panorama pp1
WHERE st_dwithin(pp._geolocation_2d, pp1._geolocation_2d, 0.00018000018::double precision) AND pp1.id <> pp.id
ORDER BY pp.id, pp1.id"""
        ),
    ]

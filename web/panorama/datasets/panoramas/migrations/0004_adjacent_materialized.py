# -*- coding: utf-8 -*-
# Generated by Django 1.9.5 on 2016-06-20 11:13
from __future__ import unicode_literals

from django.db import migrations

from geo_views import migrate


class Migration(migrations.Migration):

    dependencies = [
        ('panoramas', '0003_drop_adjacent_view')
    ]

    operations = [
        migrate.ManageMaterializedView(
            view_name="panoramas_adjacencies",
            sql="""
SELECT
    ROW_NUMBER() over (order by pp.id) as id,
    pp.id as from_pano_id,
    pp1.id as to_pano_id,
    degrees(ST_Azimuth(geography(pp.geolocation), geography(pp1.geolocation))) as direction,
    ST_Distance(geography(pp.geolocation), geography(pp1.geolocation)) as distance,
    ST_Z(pp1.geolocation)  - ST_Z(pp.geolocation) as elevation
FROM
    panoramas_panorama pp,
    panoramas_panorama pp1
WHERE
    ST_DWithin(geography(pp.geolocation), geography(pp1.geolocation), 10)
AND
    pp1.id <> pp.id
ORDER BY from_pano_id, to_pano_id"""
        ),
    ]
